<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PEX Recipes and Notes &mdash; pex 2.1.74 文档</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/translations.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="索引" href="genindex.html" />
    <link rel="search" title="搜索" href="search.html" />
    <link rel="next" title="PEX runtime environment variables" href="api/vars.html" />
    <link rel="prev" title="构建 .pex 文件" href="buildingpex.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> pex
          </a>
              <div class="version">
                2.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="whatispex.html">什么是 .pex 文件？</a></li>
<li class="toctree-l1"><a class="reference internal" href="buildingpex.html">构建 .pex 文件</a></li>
<li class="toctree-l1"><a class="reference internal" href="buildingpex.html#invoking-the-pex-utility">调用 <code class="docutils literal notranslate"><span class="pre">pex</span></code> 工具</a></li>
<li class="toctree-l1"><a class="reference internal" href="buildingpex.html#using-bdist-pex">Using <code class="docutils literal notranslate"><span class="pre">bdist_pex</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="buildingpex.html#using-pants">Using Pants</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">PEX Recipes and Notes</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#long-running-pex-applications-and-daemons">Long running PEX applications and daemons</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pex-app-in-a-container">PEX app in a container</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pex-aware-application">PEX-aware application</a></li>
<li class="toctree-l2"><a class="reference internal" href="#gunicorn-and-pex">Gunicorn and PEX</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pex-and-proxy-settings">PEX and Proxy settings</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="api/vars.html">PEX runtime environment variables</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">pex</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>PEX Recipes and Notes</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/recipes.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="pex-recipes-and-notes">
<span id="recipes"></span><h1>PEX Recipes and Notes<a class="headerlink" href="#pex-recipes-and-notes" title="永久链接至标题">¶</a></h1>
<section id="long-running-pex-applications-and-daemons">
<h2>Long running PEX applications and daemons<a class="headerlink" href="#long-running-pex-applications-and-daemons" title="永久链接至标题">¶</a></h2>
<p>If your PEXed application will run a long time, at some point you’ll likely need to debug or
otherwise inspect it using operating system tools. Unless you built your application as a
non-<code class="docutils literal notranslate"><span class="pre">--venv</span></code> <code class="docutils literal notranslate"><span class="pre">--layout</span> <span class="pre">loose</span></code> PEX, its final process information will be inscrutable in <code class="docutils literal notranslate"><span class="pre">ps</span></code>
output since all other PEX forms re-execute themselves against an installed version of themselves in
the configured <code class="docutils literal notranslate"><span class="pre">PEX_ROOT</span></code>.</p>
<p>You’ll see something like this as a result:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ ./my.pex --foo bar <span class="p">&amp;</span>
$ ps -o <span class="nb">command</span> <span class="p">|</span> grep pex
/home/jsirois/.pyenv/versions/3.10.2/bin/python3.10 /home/jsirois/.pex/unzipped_pexes/94790b07dc3768a9926dab999b41a87e399e0aa9 --foo bar
</pre></div>
</div>
<p>The original PEX file is not mentioned anywhere in the <code class="docutils literal notranslate"><span class="pre">ps</span></code> output. Worse, if you have many PEX
processes it will be unclear which process corresponds to which PEX.</p>
<p>To remedy this, simply add <a class="reference external" href="https://pypi.org/project/setproctitle/">setproctitle</a> as a dependency
for your PEX. The PEX runtime will then detect the presence of <code class="docutils literal notranslate"><span class="pre">setproctitle</span></code> and alter the
process title so you see both the Python being used to run your PEX and the PEX file being run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ ./my.pex --foo bar <span class="p">&amp;</span>
$ ps -o <span class="nb">command</span> <span class="p">|</span> grep pex
/home/jsirois/.pyenv/versions/3.10.2/bin/python3.10 /home/jsirois/dev/pantsbuild/jsirois-pex/my.pex --foo bar
</pre></div>
</div>
</section>
<section id="pex-app-in-a-container">
<h2>PEX app in a container<a class="headerlink" href="#pex-app-in-a-container" title="永久链接至标题">¶</a></h2>
<p>If you want to use a PEX application in a container, you can get the smallest container footprint
and the lowest latency application start-up by installing it with the <code class="docutils literal notranslate"><span class="pre">venv</span></code> Pex tool. First make
sure you build the pex with <code class="docutils literal notranslate"><span class="pre">--include-tools</span></code> (or <code class="docutils literal notranslate"><span class="pre">--venv</span></code>), and then install it in the
container like so:</p>
<div class="highlight-dockerfile notranslate"><div class="highlight"><pre><span></span><span class="k">FROM</span><span class="w"> </span><span class="s">python:3.10-slim</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="s">deps</span>
<span class="k">COPY</span><span class="w"> </span>/my-app.pex /
<span class="k">RUN</span><span class="w"> </span><span class="nv">PEX_TOOLS</span><span class="o">=</span><span class="m">1</span> /usr/local/bin/python3.10 /my-app.pex venv --scope<span class="o">=</span>deps --compile /my-app

<span class="k">FROM</span><span class="w"> </span><span class="s">python:3.10-slim</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="s">srcs</span>
<span class="k">COPY</span><span class="w"> </span>/my-app.pex /
<span class="k">RUN</span><span class="w"> </span><span class="nv">PEX_TOOLS</span><span class="o">=</span><span class="m">1</span> /usr/local/bin/python3.10 /my-app.pex venv --scope<span class="o">=</span>srcs --compile /my-app

<span class="k">FROM</span><span class="w"> </span><span class="s">python:3.10-slim</span>
<span class="k">COPY</span><span class="w"> </span>--from<span class="o">=</span>deps /my-app /my-app
<span class="k">COPY</span><span class="w"> </span>--from<span class="o">=</span>srcs /my-app /my-app
<span class="k">ENTRYPOINT</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;/my-app/pex&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>Here, the first two <code class="docutils literal notranslate"><span class="pre">FROM</span></code> images are illustrative. The only requirement is they need to contain
the Python interpreter your app should be run with (<code class="docutils literal notranslate"><span class="pre">/usr/local/bin/python3.10</span></code> in this example).</p>
<p>The Pex <code class="docutils literal notranslate"><span class="pre">venv</span></code> tool will:</p>
<ol class="arabic simple">
<li><p>Install the PEX as a traditional venv at <code class="docutils literal notranslate"><span class="pre">/my-app</span></code> with a script at <code class="docutils literal notranslate"><span class="pre">/my-app/pex</span></code> that runs
just like the original PEX.</p></li>
<li><p>Pre-compile all PEX Python code installed in the venv.</p></li>
</ol>
<p>Notably, the PEX venv install is done using a
<a class="reference external" href="https://docs.docker.com/develop/develop-images/multistage-build/">multi-stage build</a> to ensure
only the final venv remains on disk and it uses two layers to ensure changes to application code
do not lead to re-builds of lower layers. This accommodates the common case of modifying and
re-deploying first party code more often than third party dependencies.</p>
</section>
<section id="pex-aware-application">
<h2>PEX-aware application<a class="headerlink" href="#pex-aware-application" title="永久链接至标题">¶</a></h2>
<p>If your code benefits from knowing whether it is running from within a PEX or not, you can inspect
the <code class="docutils literal notranslate"><span class="pre">PEX</span></code> environment variable. If it is set, it will be the absolute path of the PEX your code
is running in. Normally this will be a PEX zip file, but it could be a directory path if the PEX was
built with a <code class="docutils literal notranslate"><span class="pre">--layout</span></code> of <code class="docutils literal notranslate"><span class="pre">packed</span></code> or <code class="docutils literal notranslate"><span class="pre">loose</span></code>.</p>
</section>
<section id="gunicorn-and-pex">
<h2>Gunicorn and PEX<a class="headerlink" href="#gunicorn-and-pex" title="永久链接至标题">¶</a></h2>
<p>Normally, to run a wsgi-compatible application with Gunicorn, you’d just
point Gunicorn at your application, tell Gunicorn how to run it, and you’re
ready to go - but if your application is shipping as a PEX file, you’ll have
to bundle Gunicorn as a dependency and set Gunicorn as your entry point. Gunicorn
can’t enter a PEX file to retrieve the wsgi instance, but that doesn’t prevent
the PEX from invoking Gunicorn.</p>
<p>This retains the benefit of zero <cite>pip install</cite>’s to run your service, but it
requires a bit more setup as you must ensure Gunicorn is packaged as a dependency.
The following snippets assume Flask as the wsgi framework, Django setup should be
similar:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ pex flask gunicorn myapp -c gunicorn -o ~/service.pex
</pre></div>
</div>
<p>Once your pex file is created, you need to make sure to pass your wsgi app
instance name to the CLI at runtime for Gunicorn to know how to hook into it,
configuration can be passed in the same way:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ service.pex myapp:appinstance -c /path/to/gunicorn_config.py
</pre></div>
</div>
<p>And there you have it, a fully portable python web service.</p>
</section>
<section id="pex-and-proxy-settings">
<h2>PEX and Proxy settings<a class="headerlink" href="#pex-and-proxy-settings" title="永久链接至标题">¶</a></h2>
<p>While building pex files, you may need to fetch dependencies through a proxy. The easiest way is to use pex cli with the requests extra and environment variables. Following are the steps to do just that:</p>
<ol class="arabic simple">
<li><p>Install pex with requests</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ pip install pex<span class="o">[</span>requests<span class="o">]</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>Set the environment variables</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ <span class="c1"># Hopefully your proxy supports https! If not, you can export HTTP_PROXY:</span>
$ <span class="c1"># export HTTP_PROXY=&#39;http://user:pass@address:port&#39;</span>
$ <span class="nb">export</span> <span class="nv">HTTPS_PROXY</span><span class="o">=</span><span class="s1">&#39;https://user:pass@address:port&#39;</span>
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p>Now you can test by running</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ pex -v pex
</pre></div>
</div>
<p>For more information on the requests module support for proxies via environment variables, see the official documentation here: <a class="reference external" href="http://docs.python-requests.org/en/master/user/advanced/#proxies">http://docs.python-requests.org/en/master/user/advanced/#proxies</a>.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="buildingpex.html" class="btn btn-neutral float-left" title="构建 .pex 文件" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="api/vars.html" class="btn btn-neutral float-right" title="PEX runtime environment variables" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2022, Pants project contributors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>